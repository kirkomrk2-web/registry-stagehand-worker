<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompanyBook –ü—Ä–æ–≤–µ—Ä–∫–∞ - 3 –ò–º–µ–Ω–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .search-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .search-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .name-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1em;
        }

        .input-group input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .person-result {
            margin-bottom: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }

        .person-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
        }

        .person-header h3 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .person-header .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status.success {
            background: #4caf50;
        }

        .status.no-match {
            background: #ff9800;
        }

        .status.error {
            background: #f44336;
        }

        .person-body {
            padding: 30px;
        }

        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: #555;
        }

        .summary-value {
            color: #333;
            font-weight: 500;
        }

        .companies-title {
            font-size: 1.5em;
            color: #667eea;
            margin: 30px 0 20px 0;
            font-weight: 600;
        }

        .accordion {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            background: white;
        }

        .accordion-header {
            background: #f8f9fa;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            user-select: none;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-header.active {
            background: #667eea;
            color: white;
        }

        .accordion-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .accordion-arrow {
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }

        .accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-body.active {
            max-height: 1000px;
        }

        .accordion-content {
            padding: 25px;
            background: #fafafa;
        }

        .company-detail {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .company-detail:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #667eea;
        }

        .detail-value {
            color: #333;
        }

        .no-companies {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2em;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .info-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #555;
        }

        .info-box li {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .company-detail {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç CompanyBook –ü—Ä–æ–≤–µ—Ä–∫–∞</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–µ—Ç–µ 3 –∏–º–µ–Ω–∞ –µ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞ –±–∏–∑–Ω–µ—Å —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç –≤ –ë—ä–ª–≥–∞—Ä–∏—è</p>
        </div>

        <div class="content">
            <div class="info-box">
                <h4>‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∞—Ç–∞:</h4>
                <ul>
                    <li>–í—ä–≤–µ–¥–µ—Ç–µ 3 –∏–º–µ–Ω–∞ (–ø—ä–ª–Ω–∏ –∏–º–µ–Ω–∞ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏)</li>
                    <li>–°–∏—Å—Ç–µ–º–∞—Ç–∞ —Ç—ä—Ä—Å–∏ –≤—Å—è–∫–æ –∏–º–µ –≤ CompanyBook API</li>
                    <li>–ü–æ–∫–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω–∏–∏, –∫—ä–¥–µ—Ç–æ –ª–∏—Ü–µ—Ç–æ –µ 100% —Å–æ–±—Å—Ç–≤–µ–Ω–∏–∫</li>
                    <li>–§–∏–ª—Ç—Ä–∏—Ä–∞ —Å–∞–º–æ –ï–û–û–î/–ï–¢ —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ –∏–º–µ –∏ –∞–∫—Ç–∏–≤–µ–Ω —Å—Ç–∞—Ç—É—Å</li>
                </ul>
            </div>

            <div class="search-section">
                <h2>–í—ä–≤–µ–¥–µ—Ç–µ 3 –∏–º–µ–Ω–∞ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞</h2>
                <div class="name-inputs">
                    <div class="input-group">
                        <label for="name1">–ò–º–µ 1:</label>
                        <input type="text" id="name1" placeholder="–Ω–∞–ø—Ä. –î–∞–Ω–∏–µ–ª –ú–∏–ª–µ–Ω–æ–≤ –ú–∞—Ä—Ç–∏–Ω–æ–≤">
                    </div>
                    <div class="input-group">
                        <label for="name2">–ò–º–µ 2:</label>
                        <input type="text" id="name2" placeholder="–Ω–∞–ø—Ä. –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ –ì–µ–æ—Ä–≥–∏–µ–≤">
                    </div>
                    <div class="input-group">
                        <label for="name3">–ò–º–µ 3:</label>
                        <input type="text" id="name3" placeholder="–Ω–∞–ø—Ä. –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ –î–∏–º–∏—Ç—Ä–æ–≤–∞">
                    </div>
                </div>
                <button class="search-button" onclick="searchAllNames()">
                    üîç –ü—Ä–æ–≤–µ—Ä–∏ –≤—Å–∏—á–∫–∏ –∏–º–µ–Ω–∞
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="font-size: 1.2em; color: #667eea;">–¢—ä—Ä—Å–µ–Ω–µ –≤ CompanyBook API...</p>
                <p style="color: #999; margin-top: 10px;">–¢–æ–≤–∞ –º–æ–∂–µ –¥–∞ –æ—Ç–Ω–µ–º–µ –Ω—è–∫–æ–ª–∫–æ —Å–µ–∫—É–Ω–¥–∏</p>
            </div>

            <div class="results" id="results">
                <!-- Results will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Configuration - Use CompanyBook API directly (it's FREE!)
        const API_BASE = 'https://api.companybook.bg/api';

        // Toggle accordion
        function toggleAccordion(element) {
            const header = element;
            const body = header.nextElementSibling;
            
            header.classList.toggle('active');
            body.classList.toggle('active');
        }

        // Search for a single person
        async function searchPerson(fullName) {
            try {
                // Step 1: Search for person
                const searchUrl = `${API_BASE}/people/search?name=${encodeURIComponent(fullName)}`;
                const searchResponse = await fetch(searchUrl, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0',
                        'Accept': 'application/json'
                    }
                });
                
                if (!searchResponse.ok) {
                    throw new Error(`HTTP error! status: ${searchResponse.status}`);
                }
                
                const searchData = await searchResponse.json();
                
                if (!searchData.results || searchData.results.length === 0) {
                    return {
                        name: fullName,
                        status: 'no-match',
                        message: '–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –≤ CompanyBook',
                        companies: []
                    };
                }

                // Get first result
                const person = searchData.results[0];
                const personId = person.indent || person.identifier || person.id;

                // Step 2: Get ownership data using relationships endpoint
                const ownershipUrl = `${API_BASE}/relationships/${personId}?type=ownership&depth=2`;
                const ownershipResponse = await fetch(ownershipUrl, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0',
                        'Accept': 'application/json'
                    }
                });
                
                if (!ownershipResponse.ok) {
                    throw new Error('Failed to get ownership data');
                }
                
                const ownershipData = await ownershipResponse.json();

                // Step 3: Extract companies
                const companies = [];
                
                if (ownershipData.relationships) {
                    for (const rel of ownershipData.relationships) {
                        const entity = rel.entity || {};
                        const isActive = rel.isActive !== false;
                        
                        if (!isActive || entity.type !== 'company') continue;

                        const rtype = rel.relationshipType || rel.type || '';
                        const shareStr = rel?.metadata?.share || rel?.metadata?.percentage || null;
                        const shareNum = typeof shareStr === 'string' ? parseFloat(shareStr.replace('%','')) : (typeof shareStr === 'number' ? shareStr : NaN);
                        
                        const isSole = rtype === 'SoleCapitalOwner' || (!isNaN(shareNum) && Math.round(shareNum) === 100);
                        const isET = rtype === 'PhysicalPersonTrader';

                        if (isSole || isET) {
                            const eik = entity.id || entity.uic || null;
                            
                            if (eik) {
                                // Step 4: Get company details
                                try {
                                    const companyUrl = `${API_BASE}/companies/${eik}?with_data=true`;
                                    const companyResponse = await fetch(companyUrl, {
                                        headers: {
                                            'User-Agent': 'Mozilla/5.0',
                                            'Accept': 'application/json'
                                        }
                                    });
                                    
                                    if (companyResponse.ok) {
                                        const companyData = await companyResponse.json();
                                        const comp = companyData.company || companyData || {};
                                        
                                        const lf = String(comp.legalForm || '').toLowerCase();
                                        const isEOOD = lf.includes('–µ–æ–æ–¥') || lf.includes('eood');
                                        const isETLegal = lf.includes('–µ—Ç') || lf.includes('et');
                                        
                                        if (!(isEOOD || isETLegal)) continue;
                                        
                                        const englishName = comp.companyNameTransliteration?.name || null;
                                        if (!englishName) continue;
                                        
                                        const status = String(comp.status || '').toUpperCase();
                                        const isActiveStatus = status === 'N' || status === 'E';
                                        if (!isActiveStatus) continue;
                                        
                                        const seat = comp.seat || {};
                                        
                                        companies.push({
                                            business_name_en: englishName,
                                            business_name_bg: comp.name || entity.name || '',
                                            eik: comp.uic || comp.eik || eik,
                                            vat: comp.registerInfo?.vat || (eik ? `BG${eik}` : null),
                                            entity_type: isEOOD ? 'EOOD' : 'ET',
                                            legal_form: comp.legalForm || '',
                                            status: comp.status || '',
                                            city: seat.settlement || '',
                                            region: seat.region || '',
                                            country: seat.country || 'Bulgaria',
                                            address: formatAddress(seat),
                                            incorporation_date: comp.registerInfo?.dateOfIncorporation || ''
                                        });
                                    }
                                } catch (err) {
                                    console.error('Error fetching company:', err);
                                }
                            }
                        }
                    }
                }

                return {
                    name: fullName,
                    status: companies.length > 0 ? 'success' : 'no-match',
                    message: companies.length > 0 ? `–ù–∞–º–µ—Ä–µ–Ω–∏ ${companies.length} –∫–æ–º–ø–∞–Ω–∏–∏` : '–ù—è–º–∞ –≤–∞–ª–∏–¥–Ω–∏ –ï–û–û–î/–ï–¢ —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ –∏–º–µ',
                    personData: person,
                    companies: companies
                };

            } catch (error) {
                console.error('Search error:', error);
                return {
                    name: fullName,
                    status: 'error',
                    message: `–ì—Ä–µ—à–∫–∞: ${error.message}`,
                    companies: []
                };
            }
        }

        function formatAddress(seat) {
            if (!seat) return '';
            const parts = [];
            if (seat.country) parts.push(seat.country);
            if (seat.region) parts.push(seat.region);
            if (seat.district) parts.push(seat.district);
            if (seat.municipality) parts.push(seat.municipality);
            if (seat.settlement) parts.push(seat.settlement);
            if (seat.postCode) parts.push(seat.postCode);
            return parts.join(', ');
        }

        // Search all three names
        async function searchAllNames() {
            const name1 = document.getElementById('name1').value.trim();
            const name2 = document.getElementById('name2').value.trim();
            const name3 = document.getElementById('name3').value.trim();

            if (!name1 && !name2 && !name3) {
                alert('–ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–Ω–æ –∏–º–µ!');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.querySelector('.search-button').disabled = true;

            // Search all names
            const promises = [];
            if (name1) promises.push(searchPerson(name1));
            if (name2) promises.push(searchPerson(name2));
            if (name3) promises.push(searchPerson(name3));

            try {
                const results = await Promise.all(promises);
                displayResults(results);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="error-message">
                        <strong>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ:</strong> ${error.message}
                    </div>
                `;
                document.getElementById('results').classList.add('active');
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.querySelector('.search-button').disabled = false;
            }
        }

        // Display results
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            let html = '';

            results.forEach(result => {
                const statusClass = result.status;
                const statusText = result.status === 'success' ? '‚úÖ –ù–∞–º–µ—Ä–µ–Ω–∏ –∫–æ–º–ø–∞–Ω–∏–∏' : 
                                 result.status === 'no-match' ? '‚ö†Ô∏è –ù—è–º–∞ —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è' : 
                                 '‚ùå –ì—Ä–µ—à–∫–∞';

                html += `
                    <div class="person-result">
                        <div class="person-header">
                            <h3>${result.name}</h3>
                            <span class="status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="person-body">
                            <div class="summary">
                                <div class="summary-item">
                                    <span class="summary-label">–°—Ç–∞—Ç—É—Å:</span>
                                    <span class="summary-value">${result.message}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">–ù–∞–º–µ—Ä–µ–Ω–∏ –∫–æ–º–ø–∞–Ω–∏–∏:</span>
                                    <span class="summary-value">${result.companies.length}</span>
                                </div>
                            </div>

                            ${result.companies.length > 0 ? `
                                <h4 class="companies-title">üìä –ö–æ–º–ø–∞–Ω–∏–∏ (${result.companies.length})</h4>
                                ${result.companies.map((company, idx) => `
                                    <div class="accordion">
                                        <div class="accordion-header" onclick="toggleAccordion(this)">
                                            <div class="accordion-title">
                                                ${idx + 1}. ${company.business_name_en} (${company.entity_type})
                                            </div>
                                            <div class="accordion-arrow">‚ñº</div>
                                        </div>
                                        <div class="accordion-body">
                                            <div class="accordion-content">
                                                <div class="company-detail">
                                                    <div class="detail-label">English Name:</div>
                                                    <div class +"detail-value">${company.business_name_en}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–ò–º–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏:</div>
                                                    <div class="detail-value">${company.business_name_bg}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–ï–ò–ö:</div>
                                                    <div class="detail-value">${company.eik}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">VAT:</div>
                                                    <div class="detail-value">${company.vat || 'N/A'}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–¢–∏–ø:</div>
                                                    <div class="detail-value">${company.entity_type}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–ü—Ä–∞–≤–Ω–∞ —Ñ–æ—Ä–º–∞:</div>
                                                    <div class="detail-value">${company.legal_form}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–°—Ç–∞—Ç—É—Å:</div>
                                                    <div class="detail-value">${company.status}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–ì—Ä–∞–¥:</div>
                                                    <div class="detail-value">${company.city || 'N/A'}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–†–µ–≥–∏–æ–Ω:</div>
                                                    <div class="detail-value">${company.region || 'N/A'}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–ê–¥—Ä–µ—Å:</div>
                                                    <div class="detail-value">${company.address || 'N/A'}</div>
                                                </div>
                                                <div class="company-detail">
                                                    <div class="detail-label">–î–∞—Ç–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</div>
                                                    <div class="detail-value">${company.incorporation_date || 'N/A'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            ` : `
                                <div class="no-companies">
                                    –ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –≤–∞–ª–∏–¥–Ω–∏ –∫–æ–º–ø–∞–Ω–∏–∏ —Å —Ñ–∏–ª—Ç—Ä–∏—Ç–µ:<br>
                                    ‚Ä¢ –ï–û–û–î –∏–ª–∏ –ï–¢<br>
                                    ‚Ä¢ –° –∞–Ω–≥–ª–∏–π—Å–∫–æ –∏–º–µ<br>
                                    ‚Ä¢ –ê–∫—Ç–∏–≤–µ–Ω —Å—Ç–∞—Ç—É—Å (N –∏–ª–∏ E)<br>
                                    ‚Ä¢ 100% —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('active');
        }

        // Allow Enter key to trigger search
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = [document.getElementById('name1'), document.getElementById('name2'), document.getElementById('name3')];
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchAllNames();
                    }
                });
            });
        });
    </script>
</body>
</html>
