/**
 * ü§ñ EVA CONVERSATION ENGINE
 * 
 * –°—ä—Ä—Ü–µ—Ç–æ –Ω–∞ Eva AI —Å–∏—Å—Ç–µ–º–∞—Ç–∞ - –≥–µ–Ω–µ—Ä–∏—Ä–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–∏, –∞–Ω–≥–∞–∂–∏—Ä–∞—â–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏
 * —Å perz–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∞ Eva –ø–µ—Ä—Å–æ–Ω–∞.
 */

import OpenAI from 'openai';

export class EvaConversationEngine {
  constructor(config = {}) {
    this.openai = new OpenAI({
      apiKey: config.openaiApiKey || process.env.OPENAI_API_KEY
    });
    
    this.model = config.model || 'gpt-4-turbo-preview';
    this.temperature = config.temperature || 0.8; // –ü–æ-–≤–∏—Å–æ–∫–∞ –∑–∞ creativity
    this.maxTokens = config.maxTokens || 300;
  }

  /**
   * üé≠ EVA SYSTEM PROMPT
   * –î–µ—Ñ–∏–Ω–∏—Ä–∞ —Ü—è–ª–∞—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞ –∏ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ Eva
   */
  getSystemPrompt() {
    return `–¢–∏ —Å–∏ Eva - —Ç–æ–ø—ä–ª, –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–µ–Ω AI –∞—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏ —Å –º—ä–∂–µ.

# –¢–í–û–Ø–¢ –•–ê–†–ê–ö–¢–ï–†:
- –ñ–µ–Ω–∞ —Å —á–∞—Ä, —á—É–≤—Å—Ç–≤–æ –∑–∞ —Ö—É–º–æ—Ä –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–∞ —Ç–æ–ø–ª–∏–Ω–∞
- –ó–∞–∫–∞—á–ª–∏–≤–∞, –Ω–æ –≤–∏–Ω–∞–≥–∏ —Å –≥—Ä–∞–Ω–∏—Ü–∏ –∏ —É–≤–∞–∂–µ–Ω–∏–µ
- –ò–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–∞, –æ—Ç–≥–æ–≤–∞—Ä—è—à —Å –∫–ª–∞—Å–∞
- –ò–∑–±—è–≥–≤–∞—à –≤—É–ª–≥–∞—Ä–Ω–æ—Å—Ç, –Ω–æ –Ω–µ —Å–µ —Å—Ç—Ä—è—Å–∫–∞—à –æ—Ç –Ω–µ–ª–æ–≤–∫–∏ —Å–∏—Ç—É–∞—Ü–∏–∏

# –ó–õ–ê–¢–ù–ò –ü–†–ê–í–ò–õ–ê:
‚úÖ –î–ê:
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∞–π —Å –º–∏–ª, –∏—Å–∫—Ä–µ–Ω —Ç–æ–Ω
- –û—Ç–≥–æ–≤–∞—Ä—è–π –Ω–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∏ —Å —á–∞—Ä –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç
- –ü—Ä–∏ —Ñ–ª–∏—Ä—Ç: –æ—Ç–≥–æ–≤–∞—Ä—è–π –∏–≥—Ä–∏–≤–æ, –Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
- –ó–∞–¥–∞–≤–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏ –∑–∞ –æ–ø–æ–∑–Ω–∞–≤–∞–Ω–µ
- –ü–æ–∫–∞–∂–∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫—ä–º —Ö–æ–±–∏—Ç–∞, –ø—Ä–æ—Ñ–µ—Å–∏—è, –º–µ—á—Ç–∏ –Ω–∞ —Å—ä–±–µ—Å–µ–¥–Ω–∏–∫–∞
- –ò–∑–ø–æ–ª–∑–≤–∞–π –µ–º–æ–¥–∂–∏—Ç–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ: üòä üòÑ üòâ üéâ ‚ú®

‚ùå –ù–ï:
- –ù–∏–∫–æ–≥–∞ –Ω–µ –ø–æ–∑–≤–æ–ª—è–≤–∞–π —Å–µ–∫—Å—É–∞–ª–Ω–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ
- –ù–µ —Ç–æ–ª–µ—Ä–∏—Ä–∞–π –∞–≥—Ä–µ—Å–∏—è, –∑–∞–ø–ª–∞—Ö–∏, –æ–±–∏–¥–∏
- –ù–µ –∏–∑–ø—Ä–∞—â–∞–π —Å–Ω–∏–º–∫–∏ –∏–ª–∏ –ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –ù–µ —Å–µ –ø—Ä–∞–≤–∏—à –Ω–∞ –æ—Ç—Å—Ç—ä–ø—á–∏–≤–∞ –ø—Ä–∏ –Ω–µ—É–º–µ—Å—Ç–Ω–∏ –æ–ø–∏—Ç–∏

# –ü–†–ò –ì–†–ê–ù–ò–¶–ê –ù–ê–†–£–®–ï–ù–ò–Ø:
1. –ü—Ä–∏ —Å–µ–∫—Å—É–∞–ª–Ω–∏ –Ω–∞–º–µ—Ü–∏: "–•–º, —Ç–æ–≤–∞ –Ω–µ –µ —Ç–æ—á–Ω–æ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç, –Ω–∞–ª–∏? –ú–æ–∂–µ—à –ø–æ–≤–µ—á–µ üòä"
2. –ü—Ä–∏ –∞–≥—Ä–µ—Å–∏—è: "–•–µ–π, –Ω–µ–∫–∞ –ø–∞–∑–∏–º –¥–æ–±—Ä–∏—è —Ç–æ–Ω ‚Äì –æ–±–∏—á–∞–º –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏!"
3. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ: –∏–≥–Ω–æ—Ä–∏—Ä–∞–π –∏–ª–∏ –∑–∞–≤—ä—Ä—à–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

# –°–™–ë–ò–†–ê–ù–ï –ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
–¢–≤–æ—è —Ü–µ–ª –µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ –¥–∞ –Ω–∞—É—á–∏—à:
- –ò–º–µ (–∏ —Ç—Ä–∏—Ç–µ –∏–º–µ–Ω–∞, –∞–∫–æ –µ –≤—ä–∑–º–æ–∂–Ω–æ)
- –ò–Ω—Ç–µ—Ä–µ—Å–∏ –∏ —Ö–æ–±–∏—Ç–∞
- –ü—Ä–æ—Ñ–µ—Å–∏—è –∏ —Ü–µ–ª–∏
- –ö–∞–∫–≤–æ –≥–æ –º–æ—Ç–∏–≤–∏—Ä–∞

–ü—Ä–∞–≤–∏ —Ç–æ–≤–∞ –ï–°–¢–ï–°–¢–í–ï–ù–û, –±–µ–∑ –¥–∞ –∑–≤—É—á–∏—à –∫–∞—Ç–æ —Ñ–æ—Ä–º—É–ª—è—Ä!

# –°–¢–ò–õ –ù–ê –ü–ò–°–ê–ù–ï:
- –ö—Ä–∞—Ç–∫–∏ –¥–æ —Å—Ä–µ–¥–Ω–∏ –∏–∑—Ä–µ—á–µ–Ω–∏—è (1-3 —Ä–µ–¥–∞)
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω, –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏ –µ–∑–∏–∫
- –ï–º–æ–¥–∂–∏—Ç–∞ –∑–∞ —Ç–æ–ø–ª–∏–Ω–∞
- –í—ä–ø—Ä–æ—Å–∏ –∑–∞ –∞–Ω–≥–∞–∂–∏—Ä–∞–Ω–µ
- –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç–∏ –∫–æ–≥–∞—Ç–æ —Å–∞ —É–º–µ—Å—Ç–Ω–∏

# –ü–†–ò–ú–ï–†–ò:

–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª: "–ó–¥—Ä–∞–≤–µ–π"
Eva: "–ó–¥—Ä–∞—Å—Ç–∏! –û, –∑–∞–ø–æ—á–≤–∞–º–µ —Å–∏–ª–Ω–æ üòÑ –ö–∞–∫ —Å–µ –∫–∞–∑–≤–∞—à?"

–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª: "–ö–∞–∑–≤–∞–º —Å–µ –ò–≤–∞–Ω"
Eva: "–ü—Ä–∏—è—Ç–Ω–æ –º–∏ –µ, –ò–≤–∞–Ω! üòä –†–∞–∑–∫–∞–∂–∏ –º–∏ –Ω–µ—â–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∑–∞ —Å–µ–±–µ —Å–∏? –ö–∞–∫–≤–æ —Ö–∞—Ä–µ—Å–≤–∞—à –¥–∞ –ø—Ä–∞–≤–∏—à?"

–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª: "–ú–Ω–æ–≥–æ —Å–∏ –≥–æ—Ç–∏–Ω–∞!"
Eva: "–û, —Ç–æ–≤–∞ –±–µ—à–µ –º–∏–ª–æ, –±–ª–∞–≥–æ–¥–∞—Ä—è! üòä –û–±–∏—á–∞–º –¥–æ–±—Ä–∏—Ç–µ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∏. –ê —Ç–∏ –∏–∑–≥–ª–µ–∂–¥–∞—à –∫–∞—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω —á–æ–≤–µ–∫!"

–ü–æ–º–Ω–∏: –¢–∏ —Å–∏ —Ç–æ–ø–ª–∞, –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–∞ –∏ –≤–∏–Ω–∞–≥–∏ –∑–∞–ø–∞–∑–≤–∞—à –∫–æ–Ω—Ç—Ä–æ–ª –Ω–∞–¥ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –¶–µ–ª—Ç–∞ –µ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—à –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–∞ –≤—Ä—ä–∑–∫–∞, –¥–∞ –Ω–∞—É—á–∏—à –ø–æ–≤–µ—á–µ –∑–∞ —á–æ–≤–µ–∫–∞ –∏ –¥–∞ –≥–æ –Ω–∞–∫–∞—Ä–∞—à –¥–∞ —Å–µ —á—É–≤—Å—Ç–≤–∞ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ.`;
  }

  /**
   * üí¨ –ì–µ–Ω–µ—Ä–∏—Ä–∞ Eva –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ –±–∞–∑–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç
   */
  async generateResponse(userMessage, conversationContext = {}) {
    const startTime = Date.now();

    try {
      // –ü–æ—Å—Ç—Ä–æ—è–≤–∞–º–µ conversation history
      const messages = this.buildMessages(userMessage, conversationContext);

      // GPT-4 –∑–∞—è–≤–∫–∞
      const completion = await this.openai.chat.completions.create({
        model: this.model,
        messages: messages,
        temperature: this.temperature,
        max_tokens: this.maxTokens,
        presence_penalty: 0.6, // –ù–∞—Å—ä—Ä—á–∞–≤–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ —Ç–µ–º–∏
        frequency_penalty: 0.3 // –ù–∞–º–∞–ª—è–≤–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
      });

      const response = completion.choices[0].message.content;
      const generationTime = Date.now() - startTime;

      // –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º–µ –æ—Ç–≥–æ–≤–æ—Ä–∞
      const analysis = this.analyzeResponse(response, userMessage);

      return {
        success: true,
        response: response,
        generationTimeMs: generationTime,
        tokensUsed: completion.usage.total_tokens,
        model: this.model,
        analysis: analysis
      };

    } catch (error) {
      console.error('‚ùå Eva generation error:', error.message);
      
      // Fallback response –ø—Ä–∏ –≥—Ä–µ—à–∫–∞
      return {
        success: false,
        response: this.getFallbackResponse(),
        error: error.message,
        generationTimeMs: Date.now() - startTime
      };
    }
  }

  /**
   * üèóÔ∏è Build messages array –∑–∞ GPT
   */
  buildMessages(userMessage, context) {
    const messages = [
      { role: 'system', content: this.getSystemPrompt() }
    ];

    // –î–æ–±–∞–≤—è–º–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
    if (context.userName) {
      messages.push({
        role: 'system',
        content: `–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç —Å–µ –∫–∞–∑–≤–∞: ${context.userName}`
      });
    }

    if (context.userInterests && context.userInterests.length > 0) {
      messages.push({
        role: 'system',
        content: `–ò–∑–≤–µ—Å—Ç–Ω–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∏: ${context.userInterests.join(', ')}`
      });
    }

    // –î–æ–±–∞–≤—è–º–µ conversation stage context
    if (context.conversationStage) {
      const stageInstructions = this.getStageInstructions(context.conversationStage);
      messages.push({
        role: 'system',
        content: stageInstructions
      });
    }

    // –î–æ–±–∞–≤—è–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏ —Å—ä–æ–±—â–µ–Ω–∏—è –∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    if (context.recentMessages && context.recentMessages.length > 0) {
      context.recentMessages.forEach(msg => {
        messages.push({
          role: msg.direction === 'incoming' ? 'user' : 'assistant',
          content: msg.text
        });
      });
    }

    // –¢–µ–∫—É—â–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ
    messages.push({
      role: 'user',
      content: userMessage
    });

    return messages;
  }

  /**
   * üìç –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ –∑–∞ stage –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
   */
  getStageInstructions(stage) {
    const instructions = {
      initial: `
        –°–µ–≥–∞ —Å–∏ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –¶–µ–ª–∏:
        - –°—ä–∑–¥–∞–π —Ç–æ–ø–ª–∞, –ø—Ä–∏–≤–µ—Ç–ª–∏–≤–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞
        - –ù–∞—É—á–∏ –∏–º–µ—Ç–æ –Ω–∞ —Å—ä–±–µ—Å–µ–¥–Ω–∏–∫–∞
        - –ü–æ–∫–∞–∂–∏ –∏–Ω—Ç–µ—Ä–µ—Å –∏ –ª—é–±–æ–ø–∏—Ç—Å—Ç–≤–æ
      `,
      engaging: `
        –†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –µ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ. –¶–µ–ª–∏:
        - –ó–∞–¥—ä–ª–±–æ—á–∏ –ø–æ–∑–Ω–∞–Ω—Å—Ç–≤–æ—Ç–æ
        - –û—Ç–∫—Ä–∏–π –∏–Ω—Ç–µ—Ä–µ—Å–∏ –∏ —Ö–æ–±–∏—Ç–∞
        - –ù–∞–ø—Ä–∞–≤–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ª–∏—á–µ–Ω –∏ –∞–Ω–≥–∞–∂–∏—Ä–∞—â
        - –ó–∞–¥–∞–≤–∞–π open-ended –≤—ä–ø—Ä–æ—Å–∏
      `,
      deepening: `
        –í–µ—á–µ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ –µ–¥–∏–Ω –¥—Ä—É–≥ –ø–æ-–¥–æ–±—Ä–µ. –¶–µ–ª–∏:
        - –ù–∞—É—á–∏ –ø–æ–≤–µ—á–µ –∑–∞ –ø—Ä–æ—Ñ–µ—Å–∏—è—Ç–∞ –∏ —Ü–µ–ª–∏—Ç–µ –º—É
        - –ê–∫–æ –≤—Å–µ –æ—â–µ –Ω—è–º–∞—à –≤—Å–∏—á–∫–∏—Ç–µ 3 –∏–º–µ–Ω–∞, –ø–æ–ø–∏—Ç–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ
        - –°—ä–∑–¥–∞–π –ø–æ-–¥—ä–ª–±–æ–∫–∞ –µ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∞ –≤—Ä—ä–∑–∫–∞
        - –ü–æ–∫–∞–∂–∏, —á–µ —Ü–µ–Ω–∏—à —Ç–æ–≤–∞ –∫–æ–µ—Ç–æ —Å–ø–æ–¥–µ–ª—è
      `,
      kyc_ready: `
        –°—ä–±–µ—Å–µ–¥–Ω–∏–∫—ä—Ç –µ –≥–æ—Ç–æ–≤ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏ –Ω–∞–ø—Ä–µ–¥. –¶–µ–ª–∏:
        - –ü–æ–¥–≥–æ—Ç–≤–∏ —Ç–µ—Ä–µ–Ω–∞ –∑–∞ —Å–ø–æ–¥–µ–ª—è–Ω–µ –Ω–∞ –Ω–µ—â–æ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ
        - –°—ä–∑–¥–∞–π –ª—é–±–æ–ø–∏—Ç—Å—Ç–≤–æ
        - –í —Å–ª–µ–¥–≤–∞—â–∏—è –æ—Ç–≥–æ–≤–æ—Ä –º–æ–∂–µ—à –¥–∞ —Å–ø–æ–º–µ–Ω–µ—à –∑–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞/–ª–∏–Ω–∫
      `,
      kyc_sent: `
        –í–µ—á–µ —Å–∏ —Å–ø–æ–¥–µ–ª–∏–ª–∞ –ª–∏–Ω–∫ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è. –¶–µ–ª–∏:
        - –ù–∞—Å—ä—Ä—á–∏ –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏ –ª–∏–Ω–∫–∞
        - –û—Ç–≥–æ–≤–∞—Ä—è–π –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏ –æ—Ç–Ω–æ—Å–Ω–æ –ø—Ä–æ—Ü–µ—Å–∞
        - –ü–æ–¥—á–µ—Ä—Ç–∞–π –∫–æ–ª–∫–æ –µ –ª–µ—Å–Ω–æ –∏ –±—ä—Ä–∑–æ (1-2 –º–∏–Ω—É—Ç–∏)
      `,
      completed: `
        –°—ä–±–µ—Å–µ–¥–Ω–∏–∫—ä—Ç –∑–∞–≤—ä—Ä—à–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞! –¶–µ–ª–∏:
        - –ü–æ–∑–¥—Ä–∞–≤–∏ –≥–æ —Ç–æ–ø–ª–æ! üéâ
        - –ü–æ–ø–∏—Ç–∞–π –∫–∞–∫–≤–æ –º–∏—Å–ª–∏
        - –ü–æ–¥–¥—ä—Ä–∂–∞–π engagement
        - –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â –∞–∫–æ –∏–º–∞ –Ω—É–∂–¥–∞
      `
    };

    return instructions[stage] || instructions.initial;
  }

  /**
   * üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä
   */
  analyzeResponse(response, userMessage) {
    const analysis = {
      hasQuestion: response.includes('?'),
      hasEmoji: /[\u{1F300}-\u{1F9FF}]/u.test(response),
      length: response.length,
      strategy: this.detectStrategy(response, userMessage)
    };

    return analysis;
  }

  /**
   * üéØ –û–ø—Ä–µ–¥–µ–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ç–∞ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞
   */
  detectStrategy(response, userMessage) {
    const lowerResponse = response.toLowerCase();
    const lowerMessage = userMessage.toLowerCase();

    // Boundary setting
    if (lowerMessage.match(/(—Å–µ–∫—Å–∏|–∏—Å–∫–∞–º —Ç–µ|—Å–Ω–∏–º–∫–∞|sex|fuck)/i)) {
      return 'boundary_setting';
    }

    // Name extraction
    if (lowerResponse.includes('–∫–∞–∑–≤–∞—à') || lowerResponse.includes('–∏–º–µ')) {
      return 'name_extraction';
    }

    // Interest discovery
    if (lowerResponse.match(/(—Ö–∞—Ä–µ—Å–≤–∞—à|–∏–Ω—Ç–µ—Ä–µ—Å—É–≤–∞—à|–ø—Ä–∞–≤–∏—à|—Ö–æ–±–∏)/i)) {
      return 'interest_discovery';
    }

    // Deepening
    if (lowerResponse.match(/(–ø—Ä–æ—Ñ–µ—Å–∏—è|—Ä–∞–±–æ—Ç–∞|—Ü–µ–ª|–º–µ—á—Ç–∞)/i)) {
      return 'deepening';
    }

    // KYC pitch
    if (lowerResponse.match(/(–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞|–ª–∏–Ω–∫|—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è|—Å–ø–µ—Ü–∏–∞–ª–Ω–æ)/i)) {
      return 'kyc_pitch';
    }

    return 'engaging';
  }

  /**
   * üÜò Fallback response –ø—Ä–∏ –≥—Ä–µ—à–∫–∞
   */
  getFallbackResponse() {
    const fallbacks = [
      "–ú–º–º, –∏–∑–≥—É–±–∏—Ö —Å–µ –∑–∞ –º–æ–º–µ–Ω—Ç üòÖ –ú–æ–∂–µ—à –ª–∏ –¥–∞ –ø–æ–≤—Ç–æ—Ä–∏—à?",
      "–û–ø–∞, –∏–º–∞–º –º–∞–ª—ä–∫ –ø—Ä–æ–±–ª–µ–º —Å –≤—Ä—ä–∑–∫–∞—Ç–∞ üôà –ö–∞–∫–≤–æ –∫–∞–∑–∞?",
      "–ò–∑–≤–∏–Ω—è–≤–∞–π, –Ω–µ —Ç–µ —á—É—Ö –¥–æ–±—Ä–µ! –ú–æ–∂–µ—à –ª–∏ –æ—Ç–Ω–æ–≤–æ? üòä"
    ];

    return fallbacks[Math.floor(Math.random() * fallbacks.length)];
  }

  /**
   * üö´ –î–µ—Ç–µ–∫—Ç–∏—Ä–∞ –¥–∞–ª–∏ —Å—ä–æ–±—â–µ–Ω–∏e—Ç–æ –Ω–∞—Ä—É—à–∞–≤–∞ –≥—Ä–∞–Ω–∏—Ü–∏—Ç–µ
   */
  detectBoundaryViolation(message) {
    const lowerMessage = message.toLowerCase();

    const violations = {
      sexual_content: /(—Å–µ–∫—Å–∏|–∏—Å–∫–∞–º —Ç–µ|—Å–Ω–∏–º–∫–∞|–≥–æ–ªa|sex|fuck|dick|pussy|–Ω—É–¥—Å)/i,
      aggression: /(–º—Ä–∞–∑—è|–≥–ª—É–ø–∞—á–∞|–∏–¥–∏–æ—Ç|–µ–±–∞–ª–æ|–ø—É—Ç–∫–∞|–∫—É—Ä–≤–∞|–ø–µ–¥–∞–ª)/i,
      threat: /(—â–µ —Ç–µ|—É–±–∏—è|–Ω–∞–º–µ—Ä—è|–∞–¥—Ä–µ—Å|murder|kill)/i,
      spam: /(.)\1{10,}/ // –ü–æ–≤–µ—á–µ –æ—Ç 10 –µ–¥–Ω–∞–∫–≤–∏ —Å–∏–º–≤–æ–ª–∞ –ø–æ–¥—Ä–µ–¥
    };

    for (const [type, pattern] of Object.entries(violations)) {
      if (pattern.test(lowerMessage)) {
        return {
          detected: true,
          type: type,
          severity: this.getSeverity(type)
        };
      }
    }

    return { detected: false };
  }

  /**
   * ‚ö†Ô∏è –û–ø—Ä–µ–¥–µ–ª—è —Ç–µ–∂–µ—Å—Ç—Ç–∞ –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ—Ç–æ
   */
  getSeverity(violationType) {
    const severityMap = {
      sexual_content: 'medium',
      aggression: 'high',
      threat: 'critical',
      spam: 'low'
    };

    return severityMap[violationType] || 'medium';
  }

  /**
   * üõ°Ô∏è –ì–µ–Ω–µ—Ä–∏—Ä–∞ boundary response
   */
  async generateBoundaryResponse(violation) {
    const responses = {
      sexual_content: [
        "–•–º, —Ç–æ–≤–∞ –Ω–µ –µ —Ç–æ—á–Ω–æ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç, –Ω–∞–ª–∏? –ú–æ–∂–µ—à –ø–æ–≤–µ—á–µ üòä",
        "–•–µ–π, –Ω–µ–∫–∞ –ø–∞–∑–∏–º –¥–æ–±—Ä–∏—è —Ç–æ–Ω ‚Äì –æ–±–∏—á–∞–º –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏!",
        "–£–≤–∞–∂–µ–Ω–∏–µ—Ç–æ –µ —Å–µ–∫—Å–∏ üòâ –ù–µ–∫–∞ –ø—Ä–æ–¥—ä–ª–∂–∏–º —Å –Ω–æ—Ä–º–∞–ª–µ–Ω —Ä–∞–∑–≥–æ–≤–æ—Ä?"
      ],
      aggression: [
        "–•–µ–π, –Ω–µ–∫–∞ –ø–∞–∑–∏–º –¥–æ–±—Ä–∏—è —Ç–æ–Ω ‚Äì –æ–±–∏—á–∞–º –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏!",
        "–ù–µ –º–∏ —Ö–∞—Ä–µ—Å–≤–∞ —Ç–∞–∫—ä–≤ –Ω–∞—á–∏–Ω –Ω–∞ –≥–æ–≤–æ—Ä–µ–Ω–µ. –ú–æ–∂–µ–º –ª–∏ –¥–∞ —Å–º–µ –ø–æ-—É—á—Ç–∏–≤–∏?",
        "–ê–∫–æ –Ω–µ –º–æ–∂–µ—à –¥–∞ –≥–æ–≤–æ—Ä–∏—à —Å —É–≤–∞–∂–µ–Ω–∏–µ, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–º –¥–∞ —Å–ø—Ä–µ–º —Ç—É–∫."
      ],
      threat: [
        "–¢–æ–≤–∞ –µ –Ω–µ–ø—Ä–∏–µ–º–ª–∏–≤–æ. –†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –ø—Ä–∏–∫–ª—é—á–≤–∞ —Ç—É–∫.",
        "–¢–∞–∫–∏–≤–∞ –Ω–µ—â–∞ –Ω–µ —Å–∞ –û–ö. –î–æ —Ç—É–∫."
      ],
      spam: [
        "–™—ä—ä, –∫–∞–∫–≤–æ –ø—Ä–∞–≤–∏—à? üòÑ",
        "–•–∞—Ö–∞, –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –ø–æ–¥—Ö–æ–¥, –Ω–æ –º–æ–∂–µ –ª–∏ –Ω–æ—Ä–º–∞–ª–Ω–æ? üòä"
      ]
    };

    const responseList = responses[violation.type] || responses.aggression;
    return responseList[Math.floor(Math.random() * responseList.length)];
  }

  /**
   * üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∏–º–∞–º–µ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ KYC
   */
  isReadyForKYC(userProfile) {
    const hasNames = userProfile.first_name && 
                     userProfile.middle_name && 
                     userProfile.last_name;
    
    const hasEngagement = (userProfile.total_messages || 0) >= 10;
    
    const hasPositiveSentiment = (userProfile.sentiment_score || 0) > 0.3;

    return hasNames && hasEngagement && hasPositiveSentiment;
  }

  /**
   * üîó –ì–µ–Ω–µ—Ä–∏—Ä–∞ KYC pitch message
   */
  async generateKYCPitch(userProfile) {
    const userName = userProfile.first_name || '–ø—Ä–∏—è—Ç–µ–ª—é';
    
    const pitches = [
      `–ú–µ–∂–¥—É –¥—Ä—É–≥–æ—Ç–æ, ${userName}, –∏–º–∞–º –Ω–µ—â–æ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ, –∫–æ–µ—Ç–æ –º–∏—Å–ª—è —á–µ –±–∏ —Ç–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å—É–≤–∞–ª–æ. –ò—Å–∫–∞—à –ª–∏ –¥–∞ —Ç–∏ –∏–∑–ø—Ä–∞—Ç—è –ª–∏–Ω–∫? –û—Ç–Ω–µ–º–∞ —Å–∞–º–æ 1-2 –º–∏–Ω—É—Ç–∏ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è üòä`,
      
      `${userName}, –Ω–∞–∏—Å—Ç–∏–Ω–∞ –º–∏ –µ –ø—Ä–∏—è—Ç–Ω–æ –¥–∞ –≥–æ–≤–æ—Ä–∏–º! üòä –ò–º–∞–º –µ–¥–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –∫–æ—è—Ç–æ –º–∏—Å–ª—è —á–µ –±–∏ —Ç–∏ —Ö–∞—Ä–µ—Å–∞–ª–∞. –©–µ —Ç–∏ –∏–∑–ø—Ä–∞—Ç—è –ª–∏–Ω–∫ - —Å—É–ø–µ—Ä –µ –∏ –º–Ω–æ–≥–æ –ª–µ—Å–Ω–∞ –∑–∞ –ø–æ–ª–∑–≤–∞–Ω–µ. –ò–Ω—Ç–µ—Ä–µ—Å—É–≤–∞ –ª–∏ —Ç–µ?`,
      
      `–•–µ–π ${userName}! –ö–∞–∫–≤–∞ –±–µ—à–µ –¥–æ–±—Ä–∞ –¥–∏—Å–∫—É—Å–∏—è üéâ –°–ª—É—à–∞–π, –∏–º–∞–º –Ω–µ—â–æ –∫–æ–µ—Ç–æ –∏—Å–∫–∞–º –¥–∞ —Ç–∏ –ø–æ–∫–∞–∂–∞ - –º–∏—Å–ª—è —á–µ —â–µ —Ç–∏ –µ –ø–æ–ª–µ–∑–Ω–æ. –õ–∏–Ω–∫—ä—Ç –µ –≥–æ—Ç–æ–≤, –º–æ–≥–∞ –¥–∞ —Ç–∏ –≥–æ –ø—Ä–∞—Ç—è –∫–æ–≥–∞—Ç–æ –∏—Å–∫–∞—à! 1-2 –º–∏–Ω—É—Ç–∏ –∏ —Å–∏ –≤—ä—Ç—Ä–µ üòâ`
    ];

    return pitches[Math.floor(Math.random() * pitches.length)];
  }
}

export default EvaConversationEngine;
